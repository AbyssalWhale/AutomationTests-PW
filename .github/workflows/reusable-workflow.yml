name: Reusable workflow

on:
  workflow_call:

jobs:
  dotnettests_job:
    name: .Net Playwright Tests 
    runs-on: ubuntu-latest
    env:
      TESTS_RESULTS_FILE:  $GITHUB_WORKSPACE/tests_results/testResults.trx
    permissions:
        contents: read
        issues: read
        checks: write
        pull-requests: write
    steps:
    - name: Checkout DotNet Tests
      uses: actions/checkout@v2
    - name: "Print out Workspace"
      run: ls $GITHUB_WORKSPACE
    - name: Use variables
      run: |
        echo "test result path: $TESTS_RESULTS_FILE"
    - name: Setup .NET Core SDK
      uses: actions/setup-dotnet@v3.1.0
    - name: Setup NuGet.exe for use with actions
      uses: NuGet/setup-nuget@v1.2.0
    - name: .Net Build
      uses: EasyDesk/action-dotnet-build@v1.0.0
      with:
        path: $GITHUB_WORKSPACE
    - name: Install Playwright
      shell: pwsh
      run: |
        $env:GITHUB_WORKSPACE\Core\bin\Release\net7.0\playwright.ps1 install
    - name: Update .runsettings
      shell: pwsh
      run: |
        $filePathToTask = "$GITHUB_WORKSPACE/TestsConfigurator/RunSettings/InstanceSettings.runsettings"
        $xml = New-Object XML
        $xml.Load($filePathToTask)
        $xml.SelectSingleNode("//Parameter[@name='PublishToZephyr']").value="false"
        $xml.SelectSingleNode("//Parameter[@name='ZephyrCycleName']").value="default"
        $xml.SelectSingleNode("//Parameter[@name='ZephyrCycleComment']").value="default"
        $xml.SelectSingleNode("//Parameter[@name='AgentTestsResultsFolder']").value="default"
        $xml.SelectSingleNode("//Parameter[@name='Branch']").value="develop"
        $xml.SelectSingleNode("//Parameter[@name='ZephyrToken']").value="default"
        $xml.SelectSingleNode("//Parameter[@name='ApiKey']").value="${{secrets.RAWG_KEY}}"
        $xml.SelectSingleNode("//Parameter[@name='ApiToken']").value="default"
        $xml.Save($filePathToTask)
        ${$filePathToTask}
    - name: Run Tests
      shell: pwsh
      run: |
        dotnet test $GITHUB_WORKSPACE/RegressionTests/bin/Release/net7.0/RegressionTests.dll --logger "trx;logfilename=$GITHUB_WORKSPACE/tests_results/testResults.trx" --settings "$PROJECT_PATH/TestsConfigurator/RunSettings/InstanceSettings.runsettings"
    - name: Publish Test Results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2.7.0
      with:
          check_name: DotNet Tests Results
          files: |
           $GITHUB_WORKSPACE/tests_results/testResults.trx
