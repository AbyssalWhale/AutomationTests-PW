name: Reusable workflow

on:
  workflow_call:

jobs:
  dotnettests_job:
    name: .Net Playwright Tests 
    runs-on: ubuntu-latest
    env:
      REPO_NAME: AbyssalWhale/AutomationTests-PW
      PROJECT_PATH: ./dotnet_tests/
      TESTS_RESULTS_FILE: $PROJECT_PATH/tests_results/testResults.trx
    permissions:
        contents: read
        issues: read
        checks: write
        pull-requests: write
    steps:
    - name: Checkout DotNet Tests
      uses: actions/checkout@v2
      with:
        path: $PROJECT_PATH
    - name: "Print out varriables values"
      run: echo "PROJECT PATH - $PROJECT_PATH AND - TESTS RESULTS FILE $TESTS_RESULTS_FILE"
    - name: "Print out PROJECT PATH"
      run: ls "$PROJECT_PATH"
    - name: Print out PROJECT PATH
      shell: pwsh
      run: |
        ls $PROJECT_PATH
    - name: Setup .NET Core SDK
      uses: actions/setup-dotnet@v3.1.0
    - name: Setup NuGet.exe for use with actions
      uses: NuGet/setup-nuget@v1.2.0
    - name: .Net Build
      uses: EasyDesk/action-dotnet-build@v1.0.0
      with:
        path: $PROJECT_PATH
    - name: Install Playwright
      shell: pwsh
      run: |
        $PROJECT_PATH/Core/bin/Release/net7.0/playwright.ps1 install
    - name: Update .runsettings
      shell: pwsh
      run: |
        $filePathToTask = "$PROJECT_PATH/TestsConfigurator/RunSettings/InstanceSettings.runsettings"
        $xml = New-Object XML
        $xml.Load($filePathToTask)
        $xml.SelectSingleNode("//Parameter[@name='PublishToZephyr']").value="false"
        $xml.SelectSingleNode("//Parameter[@name='ZephyrCycleName']").value="default"
        $xml.SelectSingleNode("//Parameter[@name='ZephyrCycleComment']").value="default"
        $xml.SelectSingleNode("//Parameter[@name='AgentTestsResultsFolder']").value="default"
        $xml.SelectSingleNode("//Parameter[@name='Branch']").value="develop"
        $xml.SelectSingleNode("//Parameter[@name='ZephyrToken']").value="default"
        $xml.SelectSingleNode("//Parameter[@name='ApiKey']").value="${{secrets.RAWG_KEY}}"
        $xml.SelectSingleNode("//Parameter[@name='ApiToken']").value="default"
        $xml.Save($filePathToTask)
        ${$filePathToTask}
    - name: Run Tests
      shell: pwsh
      run: |
        dotnet test $PROJECT_PATH/RegressionTests/bin/Release/net7.0/RegressionTests.dll --logger "trx;logfilename=$TESTS_RESULTS_FILE" --settings "$PROJECT_PATH/TestsConfigurator/RunSettings/InstanceSettings.runsettings"
    - name: Publish Test Results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2.7.0
      with:
          check_name: DotNet Tests Results
          files: |
           $TESTS_RESULTS_FILE
